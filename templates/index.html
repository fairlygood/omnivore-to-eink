<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="black">
    <title>Omnivore to PDF Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <style>
        :root {
            --bg: #FFEA9F;
            --accent: black;
            --accent-hover: #8a8888;
            --accent-bg: white;
            --accent-text: white;
            --border: #ffbf00
        }
        textarea, select, input, progress {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #ffffff;
            border-width: 2px;
        }
        textarea, select, input, button, .button {
            font-size: inherit;
            border-radius: var(--standard-border-radius);
            box-shadow: none;
            max-width: 100%;
            margin-bottom: .5rem;
            padding: .5rem 1.1rem;
            font-family: inherit;
            display: inline-block;
        }
        body > header {
            background-color: black;
            border-bottom: 1px solid var(--border);
            text-align: center;
            grid-column: 1/-1;
            padding: 0 .5rem 2rem;
        }
        body > header > p {
            margin-bottom: 0;
            margin-top: 0;
            color: white;
        }
        body > header > h1 {
            margin-bottom: 0;
            margin-top: 2rem;
            color: white;
        }
        .intro {
            margin-top: 0;
            font-style: italic;
        }
        .formItem {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        #sort {
            width: 9rem;
        }
        .formItem > button:nth-child(3) {
            min-width: 6.5rem;
        }
        #status {
            padding-top: 1rem;
        }

    </style>
</head>
<body>
    <header>
        <h1>Omnivore to PDF</h1>
        <p>A Fairly Good Web App</p>
    </header>
    
    <p class="notice">This application will fetch a bunch of articles from <a href="https://omnivore.app">Omnivore</a> and generate a PDF in a size suitable for large-format e-readers, such as the Kindle Scribe or Remarkable. Useful mainly for devices that can't run the official Omnivore app, and where you want to retain highlights and notes.</p>

    <div id="settingsWarning" class="warning" style="display: none;">
        Enter your API key in <a href="/settings">settings</a> to get started.
    </div>

    <form id="pdfForm">
        <p class="intro"><strong>Note:</strong> We'll only return a maximum of ten articles. This is because generating the PDF can be resource intensive, especially if the documents are long or have lots of images. It also results in smaller file sizes (and less bandwidth).</p>
        <p>Enter a label (optional) to return only articles with that label applied, and choose whether to return the newest or oldest articles. </p>
        <div class="formItem">
            <input type="text" placeholder="Label" id="tag" name="tag">
            <select id="sort" name="sort">
            <option value="asc">Oldest First</option>
            <option value="dsc">Newest First</option>
            </select> 
            <button type="submit">Fetch!</button>
        </div>
    </form>
    
    <div id="status"></div>
    
    <footer>
    <span><a href="/settings">Settings</a> | <a href="https://github.com/fairlygood/omnivore-to-epub">Source</a></span>
    </footer>
    
    <script>
    const DOMAIN = "{{ domain }}";

    document.addEventListener('DOMContentLoaded', function() {
        const apiKey = Cookies.get('omnivoreApiKey');
        const settingsWarning = document.getElementById('settingsWarning');
        const pdfForm = document.getElementById('pdfForm');

        if (!apiKey) {
            settingsWarning.style.display = 'block';
            pdfForm.style.display = 'none';
        }

        pdfForm.addEventListener('submit', function(e) {
            e.preventDefault();
            generatePDF();
        });
    });

        const funMessages = [
            "ðŸ”„ Generating PDF. Might take a minute...",
            "ðŸ”„ Mixing electrons...",
            "ðŸ”„ Initializing time paradox...",
            "ðŸ”„ Is it lunch time yet?",
            "ðŸ”„ Hacking voting machines..",
            "ðŸ”„ Rotating gravitational fields...",
            "ðŸ”„ Man, this code is a mess.",
            "ðŸ”„ Recalibrating flux capacitors...",
            "ðŸ”„ Bare with me. I'm trying!",
            "ðŸ”„ Reticulating splines...",
            "ðŸ”„ This PDF is heavy!",
            "ðŸ”„ 42",
            "ðŸ”„ Who the hell wrote this.",
            "ðŸ”„ Charging dilithium crystals...",
            "ðŸ”„ Compressing Higgs bosons...",
            "ðŸ”„ Folding space-time continuum..."
        ];

        let messageInterval;

        function generatePDF() {
        const apiKey = Cookies.get('omnivoreApiKey');
        const archive = Cookies.get('omnivoreArchive') === 'true';
        const tag = document.getElementById('tag').value;
        const sort = document.getElementById('sort').value;
        const statusDiv = document.getElementById('status');

        let messageIndex = 0;
        statusDiv.textContent = funMessages[messageIndex];
        
        messageInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % funMessages.length;
            statusDiv.textContent = funMessages[messageIndex];
        }, 2000);

        fetch(`${DOMAIN}/generate_pdf`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: apiKey,
                archive: archive,
                tag: tag || undefined,
                sort: sort
            }),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            const filename = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, '');
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            clearInterval(messageInterval);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            statusDiv.textContent = 'âœ… PDF generated successfully!';
        })
        .catch(error => {
            clearInterval(messageInterval);
            console.error('Error:', error);
            statusDiv.textContent = `Error: ${error.error || 'An unexpected error occurred. Is your API key correct?'}`;
        });
    }
    </script>
</body>
</html>